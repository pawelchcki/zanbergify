name: Gemini Review Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  statuses: write

jobs:
  check-gemini-review:
    name: Verify Gemini Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'issue_comment' && github.event.issue.pull_request)

    steps:
      - name: Check for Gemini review
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" = "issue_comment" ]; then
            PR_NUMBER=${{ github.event.issue.number }}
          else
            PR_NUMBER=${{ github.event.pull_request.number }}
          fi

          # Check if gemini-code-assist has commented on the PR
          GEMINI_COMMENTS=$(gh api repos/${{ github.repository }}/issues/${PR_NUMBER}/comments \
            --jq '[.[] | select(.user.login == "gemini-code-assist")] | length')

          # Check if gemini-code-assist has submitted a review
          GEMINI_REVIEWS=$(gh api repos/${{ github.repository }}/pulls/${PR_NUMBER}/reviews \
            --jq '[.[] | select(.user.login == "gemini-code-assist")] | length')

          TOTAL=$((GEMINI_COMMENTS + GEMINI_REVIEWS))

          if [ "$TOTAL" -gt 0 ]; then
            echo "✅ Gemini has reviewed this PR ($TOTAL review(s) found)"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "❌ Waiting for Gemini review (use /gemini review command)"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Report status
        if: always()
        run: |
          if [ "${{ steps.check.outputs.status }}" = "success" ]; then
            echo "Gemini review requirement satisfied"
          else
            echo "::error::Gemini review required. Post '/gemini review' comment to request review."
          fi
